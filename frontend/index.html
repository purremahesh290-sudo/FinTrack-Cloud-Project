<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>FinTrack Dashboard</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f6f7fb;}
  .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
  button { padding: 8px 14px; border-radius: 6px; background:#0b76ef; color:white; border:0; cursor:pointer; }
  input, select { padding:8px; border-radius:6px; border:1px solid #ccc; width:100%; }
</style>
</head>

<body>
<h2>FinTrack Dashboard</h2>

<div class="card">
  <h3>Sign In</h3>
  <input id="email" placeholder="Enter email" />
  <button id="btnSignIn">Sign In</button>
  <p id="loginStatus"></p>
  <hr>
  <label>Your User ID:</label>
  <input id="userIdFetch" readonly />
</div>

<div class="card">
  <h3>Upload CSV</h3>
  <input type="file" id="csvFile" accept=".csv" />
  <button id="btnUploadCsv">Upload</button>
  <p id="uploadResult"></p>
</div>

<div class="card">
  <h3>Add Transaction</h3>
  <input id="tAmount" placeholder="Amount" />
  <input id="tCountry" placeholder="Country (optional)" />
  <input id="tMerchant" placeholder="Merchant (optional)" />
  <button id="btnAddTx">Add</button>
  <p id="txResult"></p>
</div>

<div class="card">
  <h3>Last 30 Transactions</h3>
  <button id="btnRefresh">Refresh</button>
  <div id="txList"></div>
</div>

<script>
const API_BASE = "http://fintrack-web.eba-dfun6p2q.eu-west-1.elasticbeanstalk.com/api";

let currentUser = null;
const email = document.getElementById('email');
const btnSignIn = document.getElementById('btnSignIn');
const loginStatus = document.getElementById('loginStatus');
const userIdFetch = document.getElementById('userIdFetch');

const csvFile = document.getElementById('csvFile');
const btnUploadCsv = document.getElementById('btnUploadCsv');
const uploadResult = document.getElementById('uploadResult');

const btnAddTx = document.getElementById('btnAddTx');
const tAmount = document.getElementById('tAmount');
const tCountry = document.getElementById('tCountry');
const tMerchant = document.getElementById('tMerchant');
const txResult = document.getElementById('txResult');

const btnRefresh = document.getElementById('btnRefresh');
const txList = document.getElementById('txList');

btnSignIn.addEventListener('click', async () => {
  const e = email.value.trim();
  if (!e) return alert("Enter email");

  const r = await fetch(API_BASE + "/auth/echo", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ email:e })
  });
  const j = await r.json();
  currentUser = j;
  userIdFetch.value = j.id;
  loginStatus.textContent = "Signed in: " + j.email;
});

// ---------- CSV VALIDATION + UPLOAD ----------
btnUploadCsv.addEventListener('click', async () => {
  if (!currentUser && !userIdFetch.value)
    return alert("Sign in or paste your user id first.");

  const f = csvFile.files[0];
  if (!f) return alert("Choose a CSV file first.");

  // Validate CSV
  const text = await f.slice(0, 10000).text();
  const firstLine = text.split(/\r?\n/).find(l => l.trim() !== "");
  if (!firstLine) return alert("CSV looks empty");

  const normalize = h => String(h).replace(/^\uFEFF/,"")
    .replace(/[()\[\]"]/g,"")
    .replace(/[^\w\s\-]/g," ")
    .replace(/\s+/g," ")
    .trim().toLowerCase();

  const headers = firstLine.split(",").map(h => normalize(h));

  const has = (tokens) => headers.some(h => tokens.some(t => h.includes(t)));

  const amountTokens = ["amount","amt","value","transaction_amount","monthly_expense_total"];
  const dateTokens = ["timestamp","date","datetime","transaction_date"];
  const merchantTokens = ["merchant","shop","vendor","store","description"];

  if (!has(amountTokens)) {
    return alert("CSV missing amount column");
  }
  if (!has(dateTokens)) {
    return alert("CSV missing date/timestamp column");
  }

  const fd = new FormData();
  fd.append("file", f);
  fd.append("user_id", currentUser ? currentUser.id : userIdFetch.value);

  uploadResult.textContent = "Uploading...";
  btnUploadCsv.disabled = true;

  try {
    const r = await fetch(API_BASE + "/transactions/upload", { method:"POST", body:fd });
    const j = await r.json();
    if (!r.ok) throw new Error(j.error);
    uploadResult.textContent = "Uploaded. Job: " + j.job_id;
    setTimeout(()=> btnRefresh.click(), 2000);
  } catch(err) {
    uploadResult.textContent = "Upload failed: " + err.message;
  }

  btnUploadCsv.disabled = false;
  csvFile.value = "";
});

// ---------- ADD TX ----------
btnAddTx.addEventListener("click", async () => {
  const user_id = currentUser ? currentUser.id : userIdFetch.value.trim();
  const amount = tAmount.value;
  if (!user_id || !amount) return alert("Missing fields");

  const r = await fetch(API_BASE+"/transactions",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      user_id,
      amount,
      country:tCountry.value,
      merchant:tMerchant.value
    })
  });
  const j = await r.json();
  txResult.textContent = "Risk score: "+j.risk_score;
});

// ---------- REFRESH ----------
btnRefresh.addEventListener("click", async () => {
  const user_id = currentUser ? currentUser.id : userIdFetch.value.trim();
  if (!user_id) return alert("Sign in first.");

  const r = await fetch(API_BASE+"/transactions?user_id="+user_id);
  const j = await r.json();

  txList.innerHTML = j.map(t =>
    `<div>â‚¬${t.amount} - ${t.merchant} (${t.risk_score})</div>`
  ).join("");
});
</script>

</body>
</html>
